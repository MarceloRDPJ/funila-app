<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila ‚Äî Links de Campanha</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .mode-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px; }
        .mode-card {
            border:1.5px solid var(--border-strong); border-radius:10px;
            padding:14px 12px; cursor:pointer; transition:all .15s;
            background:var(--bg-tertiary); text-align:center; user-select:none;
        }
        .mode-card:hover { border-color:rgba(59,110,248,.4); background:rgba(59,110,248,.05); }
        .mode-card.selected {
            border-color:var(--accent); background:rgba(59,110,248,.1);
            box-shadow:0 0 0 3px rgba(59,110,248,.15);
        }
        .mode-icon  { font-size:1.6rem; margin-bottom:6px; }
        .mode-label { font-size:.78rem; font-weight:600; color:var(--text-primary); margin-bottom:3px; }
        .mode-desc  { font-size:.7rem; color:var(--text-muted); line-height:1.4; }

        .field-conditional { display:none; }
        .field-conditional.visible { display:block; }

        .flow-visual {
            display:flex; align-items:center; gap:6px;
            background:rgba(59,110,248,.06); border:1px solid rgba(59,110,248,.15);
            border-radius:8px; padding:10px 14px; margin-bottom:16px; flex-wrap:wrap;
        }
        .flow-node { font-size:.72rem; font-weight:600; padding:4px 10px; border-radius:99px; white-space:nowrap; }
        .flow-node.ad      { background:rgba(245,158,11,.15);  color:#F59E0B; }
        .flow-node.track   { background:rgba(59,110,248,.15);  color:#3B6EF8; }
        .flow-node.mid     { background:rgba(167,139,250,.15); color:#A78BFA; }
        .flow-node.dest    { background:rgba(34,197,94,.15);   color:#22C55E; }
        .flow-arrow        { color:var(--text-muted); font-size:.8rem; }

        .funnel-badge { display:inline-flex; align-items:center; gap:4px; font-size:.7rem; font-weight:600; padding:2px 8px; border-radius:99px; }
        .funnel-badge.form    { background:rgba(59,110,248,.12);  color:#3B6EF8; }
        .funnel-badge.capture { background:rgba(167,139,250,.12); color:#A78BFA; }
        .funnel-badge.landing { background:rgba(34,197,94,.12);   color:#22C55E; }

        .help-text { font-size:.75rem; color:var(--text-muted); margin-top:4px; line-height:1.5; }
        .modal-box { max-width:520px; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Leads
        </a></li>
        <li class="nav-item"><a href="links.html" class="active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
            Formul√°rio
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <h1 class="page-title">Links de Campanha</h1>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ Novo Link</button>
    </div>

    <div class="page-body">
        <!-- Fluxo visual explicativo -->
        <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:10px;padding:14px 20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <span style="font-size:.75rem;color:var(--text-muted);font-weight:500;white-space:nowrap">Fluxo:</span>
            <span style="font-size:.75rem;padding:3px 10px;border-radius:99px;background:rgba(245,158,11,.12);color:#F59E0B;font-weight:600">üì¢ Propaganda</span>
            <span style="color:var(--text-muted);font-size:.9rem">‚Üí</span>
            <span style="font-size:.75rem;padding:3px 10px;border-radius:99px;background:rgba(59,110,248,.12);color:#3B6EF8;font-weight:600">üîó Link Funila</span>
            <span style="color:var(--text-muted);font-size:.9rem">‚Üí</span>
            <span style="font-size:.75rem;padding:3px 10px;border-radius:99px;background:rgba(167,139,250,.12);color:#A78BFA;font-weight:600">üìã Captura de dados</span>
            <span style="color:var(--text-muted);font-size:.9rem">‚Üí</span>
            <span style="font-size:.75rem;padding:3px 10px;border-radius:99px;background:rgba(34,197,94,.12);color:#22C55E;font-weight:600">‚úÖ Destino final</span>
            <span style="margin-left:auto;font-size:.72rem;color:var(--text-muted)">Rastreio ponta a ponta em cada etapa</span>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Modo de captura</th>
                        <th>Link rastre√°vel</th>
                        <th>Destino final</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="links-body">
                    <tr><td colspan="5"><div class="empty-state">Carregando...</div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- ‚îÄ‚îÄ Modal ‚îÄ‚îÄ -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <span class="modal-title">Novo Link de Campanha</span>
            <button class="modal-close" onclick="closeModal()">&#x2715;</button>
        </div>
        <form id="link-form" class="modal-form" onsubmit="createLink(event)">

            <div class="form-group">
                <label>Nome da campanha</label>
                <input type="text" id="link-name" required placeholder="Ex: Instagram Setor Oeste">
            </div>

            <div class="form-group">
                <label style="margin-bottom:8px;display:block">Como quer capturar os leads?</label>
                <div class="mode-grid">
                    <div class="mode-card selected" data-mode="form" onclick="selectMode('form',this)">
                        <div class="mode-icon">üìã</div>
                        <div class="mode-label">Formul√°rio Funila</div>
                        <div class="mode-desc">Perguntas r√°pidas em etapas. Score autom√°tico.</div>
                    </div>
                    <div class="mode-card" data-mode="landing" onclick="selectMode('landing',this)">
                        <div class="mode-icon">üéØ</div>
                        <div class="mode-label">P√°gina Padr√£o</div>
                        <div class="mode-desc">Landing de alta convers√£o pronta pra usar.</div>
                    </div>
                    <div class="mode-card" data-mode="capture" onclick="selectMode('capture',this)">
                        <div class="mode-icon">üîç</div>
                        <div class="mode-label">P√°gina Pr√≥pria</div>
                        <div class="mode-desc">Sua p√°gina existente com rastreio injetado.</div>
                    </div>
                </div>
                <input type="hidden" id="link-funnel-type" value="form">
            </div>

            <!-- Preview do fluxo din√¢mico -->
            <div class="flow-visual">
                <span class="flow-node ad">üì¢ An√∫ncio</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-node track">üîó Link Funila</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-node mid" id="flow-mid">üìã Formul√°rio Funila</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-node dest" id="flow-dest-preview">‚úÖ Destino final</span>
            </div>

            <!-- S√≥ aparece no modo "capture" -->
            <div class="form-group field-conditional" id="field-capture-url">
                <label>URL da sua p√°gina de captura</label>
                <input type="url" id="link-capture-url" placeholder="https://suapagina.com/landing">
                <p class="help-text">
                    O Funila acessa essa URL, faz uma c√≥pia e injeta um script invis√≠vel de rastreio. Voc√™ troca s√≥ o link do an√∫ncio ‚Äî sua p√°gina n√£o muda nada. A gente rastreia cliques, quais campos foram preenchidos e onde as pessoas desistem.
                </p>
            </div>

            <div class="form-group">
                <label>Destino final <span style="color:var(--text-muted);font-weight:400;font-size:.78rem">‚Äî ap√≥s a captura</span></label>
                <input type="url" id="link-dest" required placeholder="https://wa.me/5562999999999"
                    oninput="updateDestPreview(this.value)">
                <p class="help-text" id="dest-help">
                    Para onde o lead vai depois de preencher o formul√°rio. WhatsApp, site de obrigado, qualquer URL.
                </p>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="form-group">
                    <label>UTM Source <span style="color:var(--text-muted);font-weight:400">(opcional)</span></label>
                    <input type="text" id="link-utm-source" placeholder="instagram, google...">
                </div>
                <div class="form-group">
                    <label>UTM Campaign <span style="color:var(--text-muted);font-weight:400">(opcional)</span></label>
                    <input type="text" id="link-utm-campaign" placeholder="nome-campanha">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="create-btn">Criar link</button>
            </div>
        </form>
    </div>
</div>

<script src="js/auth.js"></script>
<script>
const TRACKER_BASE = Auth.API_URL;

const modeConfig = {
    form:    { midLabel:"üìã Formul√°rio Funila",      destHelp:"Para onde o lead vai depois do formul√°rio. WhatsApp, site, qualquer URL.", showCapture:false },
    landing: { midLabel:"üéØ P√°gina Padr√£o Funila",   destHelp:"Para onde o lead vai depois da landing page. Normalmente WhatsApp ou p√°gina de obrigado.", showCapture:false },
    capture: { midLabel:"üîç Sua P√°gina (rastreada)", destHelp:"Para onde o lead vai depois de sair da sua p√°gina. O Funila detecta o submit e redireciona.", showCapture:true },
};

function selectMode(mode, el) {
    document.querySelectorAll(".mode-card").forEach(c => c.classList.remove("selected"));
    el.classList.add("selected");
    document.getElementById("link-funnel-type").value = mode;
    const cfg = modeConfig[mode];
    document.getElementById("flow-mid").textContent   = cfg.midLabel;
    document.getElementById("dest-help").textContent  = cfg.destHelp;
    const capField = document.getElementById("field-capture-url");
    capField.classList.toggle("visible", cfg.showCapture);
    document.getElementById("link-capture-url").required = cfg.showCapture;
}

function updateDestPreview(val) {
    const el = document.getElementById("flow-dest-preview");
    if (!val) { el.textContent = "‚úÖ Destino final"; return; }
    try {
        if (val.includes("wa.me")) el.textContent = "üí¨ WhatsApp";
        else el.textContent = "üåê " + new URL(val).hostname;
    } catch(e) { el.textContent = "‚úÖ Destino final"; }
}

function openModal()  { document.getElementById("modal").classList.add("open"); }
function closeModal() {
    document.getElementById("modal").classList.remove("open");
    document.getElementById("link-form").reset();
    selectMode("form", document.querySelector(".mode-card[data-mode='form']"));
    document.getElementById("flow-dest-preview").textContent = "‚úÖ Destino final";
}

document.addEventListener("DOMContentLoaded", async () => {
    const session = await Auth.checkAuth();
    if (session) loadLinks();
});

async function loadLinks() {
    const session = await Auth.checkAuth();
    if (!session) return;
    const res   = await fetch(`${Auth.API_URL}/links`, { headers:{"Authorization":`Bearer ${session.access_token}`} });
    const links = await res.json();
    const tbody = document.getElementById("links-body");

    if (!links.length) {
        tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><p>Nenhum link criado ainda.</p></div></td></tr>`;
        return;
    }

    const modeLabels = {
        form:    '<span class="funnel-badge form">üìã Formul√°rio</span>',
        landing: '<span class="funnel-badge landing">üéØ Landing Page</span>',
        capture: '<span class="funnel-badge capture">üîç P√°gina Pr√≥pria</span>',
    };

    tbody.innerHTML = links.map(link => {
        const shortUrl  = `${TRACKER_BASE}/t/${link.slug}`;
        const badge     = modeLabels[link.funnel_type || "form"] || modeLabels.form;
        const destShort = link.destination.length > 35 ? link.destination.substring(0,35)+"‚Ä¶" : link.destination;
        return `<tr>
            <td data-label="Nome">
                <span style="font-weight:600">${link.name}</span>
                ${link.utm_source ? `<br><span class="text-muted" style="font-size:.72rem">UTM: ${link.utm_source}</span>` : ""}
            </td>
            <td data-label="Modo">${badge}</td>
            <td data-label="Link">
                <span class="font-mono" style="color:var(--accent);font-size:.78rem">/t/${link.slug}</span>
            </td>
            <td data-label="Destino">
                <span class="text-muted" style="font-size:.8rem" title="${link.destination}">${destShort}</span>
            </td>
            <td data-label="A√ß√µes" style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn btn-outline" style="padding:5px 10px;font-size:.78rem"
                    onclick="copyLink('${shortUrl}',this)">Copiar</button>
                <button class="btn btn-outline" style="padding:5px 10px;font-size:.78rem;color:var(--error);border-color:rgba(248,113,113,.3)"
                    onclick="deleteLink('${link.id}')">Excluir</button>
            </td>
        </tr>`;
    }).join("");
}

async function createLink(e) {
    e.preventDefault();
    const session = await Auth.checkAuth();
    if (!session) return;
    const btn = document.getElementById("create-btn");
    btn.disabled = true; btn.textContent = "Criando...";

    const payload = {
        name:         document.getElementById("link-name").value,
        destination:  document.getElementById("link-dest").value,
        funnel_type:  document.getElementById("link-funnel-type").value,
        capture_url:  document.getElementById("link-capture-url").value || null,
        utm_source:   document.getElementById("link-utm-source").value   || null,
        utm_campaign: document.getElementById("link-utm-campaign").value || null,
    };

    try {
        const res = await fetch(`${Auth.API_URL}/links`, {
            method:"POST",
            headers:{"Authorization":`Bearer ${session.access_token}`,"Content-Type":"application/json"},
            body: JSON.stringify(payload)
        });
        btn.disabled = false; btn.textContent = "Criar link";
        if (res.ok) { closeModal(); loadLinks(); }
        else { const err = await res.json().catch(()=>({})); alert(err.detail || "Erro ao criar link."); }
    } catch(err) {
        btn.disabled = false; btn.textContent = "Criar link";
        alert("Erro de conex√£o.");
    }
}

async function deleteLink(id) {
    if (!confirm("Excluir este link?")) return;
    const session = await Auth.checkAuth();
    if (!session) return;
    await fetch(`${Auth.API_URL}/links/${id}`,{method:"DELETE",headers:{"Authorization":`Bearer ${session.access_token}`}});
    loadLinks();
}

function copyLink(url, btn) {
    navigator.clipboard.writeText(url).then(() => {
        const orig = btn.textContent;
        btn.textContent = "‚úì Copiado!";
        btn.style.color = "var(--success)";
        setTimeout(() => { btn.textContent = orig; btn.style.color = ""; }, 1800);
    });
}

function openSidebar()  { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebar-overlay").classList.add("open"); }
function closeSidebar() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebar-overlay").classList.remove("open"); }
</script>
</body>
</html>
