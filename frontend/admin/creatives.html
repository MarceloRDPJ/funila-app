<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — Monitoramento de Criativos</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .metric-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
        }
        .metric-title { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; }
        .metric-value { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
        .metric-change { font-size: 0.8rem; color: var(--success); display: flex; align-items: center; gap: 4px; }

        table.creative-table th { background: var(--bg-tertiary); position: sticky; top: 0; }
        .bar-container { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); border-radius: 4px; }
        .success-fill { background: var(--success); }
        .warn-fill { background: var(--warm); }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <i data-lucide="layout-dashboard" class="nav-icon"></i>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html">
            <i data-lucide="users" class="nav-icon"></i>
            Leads CRM
        </a></li>
        <li class="nav-item"><a href="creatives.html" class="active">
            <i data-lucide="monitor-play" class="nav-icon"></i>
            Criativos
        </a></li>
        <li class="nav-item"><a href="links.html">
            <i data-lucide="link" class="nav-icon"></i>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <i data-lucide="clipboard-list" class="nav-icon"></i>
            Formulário
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <i data-lucide="log-out" class="nav-icon" style="width:16px;height:16px"></i>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <i data-lucide="menu"></i>
            </button>
            <h1 class="page-title">Monitoramento de Criativos</h1>
        </div>
        <button class="btn btn-outline" onclick="loadMetrics()">
            <i data-lucide="refresh-cw" style="width:16px"></i> Atualizar
        </button>
    </div>

    <div class="page-body">

        <!-- Global Abandonment Metrics -->
        <div class="metrics-grid" id="abandonment-metrics">
            <div class="metric-card">
                <div class="metric-title">Abandono Etapa 1</div>
                <div class="metric-value" id="ab-step1">0%</div>
                <div class="metric-change">Topo de Funil</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Abandono Etapa 2</div>
                <div class="metric-value" id="ab-step2">0%</div>
                <div class="metric-change">Meio de Funil</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Abandono Etapa 3</div>
                <div class="metric-value" id="ab-step3">0%</div>
                <div class="metric-change">Fundo de Funil</div>
            </div>
        </div>

        <div class="card" style="margin-bottom:32px;padding:0;overflow:hidden">
            <div style="padding:20px;border-bottom:1px solid var(--border)">
                <h3 style="font-size:1.1rem;font-weight:600">Performance por Criativo (UTM Content)</h3>
            </div>
            <div style="overflow-x:auto">
                <table class="creative-table">
                    <thead>
                        <tr>
                            <th>Criativo</th>
                            <th>Cliques</th>
                            <th>Retenção 1</th>
                            <th>Retenção 2</th>
                            <th>Retenção 3</th>
                            <th>Conversão Final</th>
                            <th>Vendas</th>
                        </tr>
                    </thead>
                    <tbody id="creatives-body">
                        <tr><td colspan="7" style="text-align:center;padding:40px">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</main>

<script src="js/auth.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const session = await Auth.checkAuth();
        if (session) {
            loadMetrics();
            loadAbandonment();
        }
    });

    async function loadMetrics() {
        const session = await Auth.checkAuth();
        try {
            const res = await fetch(`${Auth.API_URL}/metrics/retention`, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            const data = await res.json();
            renderTable(data);
        } catch (e) {
            console.error(e);
        }
    }

    async function loadAbandonment() {
        const session = await Auth.checkAuth();
        try {
            const res = await fetch(`${Auth.API_URL}/metrics/abandonment`, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            const data = await res.json();
            document.getElementById("ab-step1").innerText = (data.step_1_drop_rate * 100).toFixed(1) + "%";
            document.getElementById("ab-step2").innerText = (data.step_2_drop_rate * 100).toFixed(1) + "%";
            document.getElementById("ab-step3").innerText = (data.step_3_drop_rate * 100).toFixed(1) + "%";
        } catch (e) {
            console.error(e);
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById("creatives-body");
        if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px">Nenhum dado encontrado.</td></tr>`;
            return;
        }

        tbody.innerHTML = data.map(item => `
            <tr>
                <td style="font-family:var(--font-mono);color:var(--accent)">${item.utm_content}</td>
                <td>${item.clicks}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:30px">${(item.retention_1 * 100).toFixed(0)}%</span>
                        <div class="bar-container"><div class="bar-fill" style="width:${item.retention_1 * 100}%"></div></div>
                    </div>
                </td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:30px">${(item.retention_2 * 100).toFixed(0)}%</span>
                        <div class="bar-container"><div class="bar-fill" style="width:${item.retention_2 * 100}%"></div></div>
                    </div>
                </td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:30px">${(item.retention_3 * 100).toFixed(0)}%</span>
                        <div class="bar-container"><div class="bar-fill" style="width:${item.retention_3 * 100}%"></div></div>
                    </div>
                </td>
                <td>
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="width:30px;font-weight:600;color:var(--success)">${(item.final_conversion * 100).toFixed(1)}%</span>
                        <div class="bar-container"><div class="bar-fill success-fill" style="width:${item.final_conversion * 100}%"></div></div>
                    </div>
                </td>
                <td>${item.converted}</td> <!-- Vendas (converted count) -->
            </tr>
        `).join("");
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
