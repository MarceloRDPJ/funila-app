<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — CRM de Leads</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="kanban.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* Drawer Styles */
        .drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .drawer {
            position: fixed; top: 0; right: 0; bottom: 0; width: 480px; max-width: 90vw;
            background: #0F1115; border-left: 1px solid var(--border);
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1001; display: flex; flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.4);
        }
        .drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            background: #1C212B;
        }
        .drawer-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .drawer-close {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            padding: 4px; border-radius: 4px; transition: color 0.2s;
        }
        .drawer-close:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }

        .drawer-body {
            flex: 1; overflow-y: auto; padding: 24px;
        }

        .drawer-section { margin-bottom: 32px; }
        .drawer-section-title {
            font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .info-card {
            background: #1C212B; border: 1px solid var(--border); border-radius: 8px; padding: 12px;
        }
        .info-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .info-value { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .info-value.score { color: var(--accent); }
        .info-value.serasa { color: #A78BFA; }

        .response-item {
            background: #1C212B; border: 1px solid var(--border); border-radius: 8px;
            padding: 12px; margin-bottom: 8px;
        }
        .response-label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .response-val { font-size: 0.9rem; color: var(--text-primary); }

        /* Timeline */
        .timeline { position: relative; padding-left: 24px; border-left: 2px solid var(--border); margin-left: 8px; }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-dot {
            position: absolute; left: -31px; top: 0; width: 12px; height: 12px;
            border-radius: 50%; background: var(--bg-secondary); border: 2px solid var(--accent);
        }
        .timeline-date { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .timeline-content { font-size: 0.9rem; color: var(--text-primary); background: #1C212B; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .timeline-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <i data-lucide="layout-dashboard" class="nav-icon"></i>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html" class="active">
            <i data-lucide="users" class="nav-icon"></i>
            Leads CRM
        </a></li>
        <li class="nav-item"><a href="links.html">
            <i data-lucide="link" class="nav-icon"></i>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <i data-lucide="clipboard-list" class="nav-icon"></i>
            Formulário
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <i data-lucide="log-out" class="nav-icon" style="width:16px;height:16px"></i>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <i data-lucide="menu"></i>
            </button>
            <h1 class="page-title">Gestão de Leads</h1>
        </div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-outline" onclick="exportLeads()">
                <i data-lucide="download" style="width:16px"></i>
                CSV
            </button>
            <button class="btn btn-outline" onclick="loadLeads()">
                <i data-lucide="refresh-cw" style="width:16px"></i>
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <div style="position:relative;flex:1">
            <i data-lucide="search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;color:var(--text-muted)"></i>
            <input type="search" id="filter-search" placeholder="Buscar nome, telefone..."
                oninput="debounceSearch()" style="padding-left:32px;width:100%">
        </div>
    </div>

    <div class="page-body" style="padding-top:0">
        <div id="kanban-board" class="kanban-board">
            <div class="empty-state" style="width:100%">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="pagination" id="pagination-controls" style="display:flex;justify-content:center;align-items:center;gap:16px;margin-top:10px;margin-bottom:20px">
        </div>
    </div>
</main>

<!-- Drawer Detalhes -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="lead-drawer">
    <div class="drawer-header">
        <h3 class="drawer-title">Detalhes do Lead</h3>
        <button class="drawer-close" onclick="closeDrawer()"><i data-lucide="x"></i></button>
    </div>
    <div class="drawer-body" id="drawer-content">
        <div style="text-align:center;padding:40px"><div class="spinner"></div></div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script src="js/auth.js"></script>
<script src="kanban.js"></script>
<script>
    let currentPage = 1;
    let limit = 100;
    let searchTimer = null;

    document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const session = await Auth.checkAuth();
        if (session) loadLeads();
    });

    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => loadLeads(1), 500);
    }

    async function loadLeads(page = 1) {
        currentPage = page;
        const session = await Auth.checkAuth();
        if (!session) return;

        const searchFilter = document.getElementById("filter-search").value;
        let url = `${Auth.API_URL}/leads?page=${page}&limit=${limit}`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro ao buscar leads");
            const json = await res.json();

            if (typeof renderKanbanBoard === 'function') {
                renderKanbanBoard(json.data);
            } else {
                console.error("renderKanbanBoard not found");
            }

            renderPagination(json.total, json.page, json.limit);
        } catch (err) {
            console.error(err);
            document.getElementById("kanban-board").innerHTML =
                `<div class="empty-state" style="width:100%"><p style="color:var(--error)">Erro ao carregar leads.</p></div>`;
        }
    }

    function renderPagination(total, page, limit) {
        const totalPages = Math.ceil(total / limit);
        const container = document.getElementById("pagination-controls");

        if (totalPages <= 1) {
            container.innerHTML = "";
            return;
        }

        container.innerHTML = `
            <button class="btn btn-outline" ${page <= 1 ? "disabled" : ""} onclick="loadLeads(${page - 1})">Anterior</button>
            <span class="text-muted" style="font-size:.85rem">Página ${page} de ${totalPages}</span>
            <button class="btn btn-outline" ${page >= totalPages ? "disabled" : ""} onclick="loadLeads(${page + 1})">Próxima</button>
        `;
    }

    async function exportLeads() {
        const session = await Auth.checkAuth();
        if (!session) return;
        const searchFilter = document.getElementById("filter-search").value;
        let url = `${Auth.API_URL}/leads/export?`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, { headers: { "Authorization": `Bearer ${session.access_token}` } });
            if (!res.ok) throw new Error("Erro");
            const blob = await res.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "leads.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch(e) {
            alert("Erro ao exportar");
        }
    }

    async function openLeadDetails(leadId) {
        const overlay = document.getElementById("drawer-overlay");
        const drawer = document.getElementById("lead-drawer");
        const content = document.getElementById("drawer-content");

        overlay.classList.add("open");
        drawer.classList.add("open");
        content.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div></div>';

        const session = await Auth.checkAuth();
        if (!session) return;

        try {
            const res = await fetch(`${Auth.API_URL}/leads/${leadId}`, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro");
            const data = await res.json();
            renderLeadDetails(data, content);
        } catch (e) {
            console.error(e);
            content.innerHTML = '<div style="color:var(--error);text-align:center">Erro ao carregar detalhes.</div>';
        }
    }

    function closeDrawer() {
        document.getElementById("drawer-overlay").classList.remove("open");
        document.getElementById("lead-drawer").classList.remove("open");
    }

    function renderLeadDetails(data, container) {
        const l = data.lead;
        const responses = data.responses || [];
        const timeline = data.timeline || [];
        const score = (l.internal_score || 0) + (l.external_score || 0);

        // Header Info
        const phoneClean = l.phone ? l.phone.replace(/\D/g, "") : "";
        const waLink = phoneClean ? `https://wa.me/55${phoneClean}` : "#";

        let html = `
            <div style="margin-bottom:32px">
                <h2 style="font-size:1.5rem;font-weight:600;margin-bottom:8px">${l.name || "Sem Nome"}</h2>
                <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center">
                    <a href="${waLink}" target="_blank" class="btn btn-primary" style="padding:6px 12px;font-size:0.85rem">
                        <i data-lucide="message-circle" style="width:16px"></i> WhatsApp
                    </a>
                    <div style="font-size:0.85rem;color:var(--text-muted)">
                        <i data-lucide="map-pin" style="width:14px;display:inline;vertical-align:middle"></i>
                        Origem: <span style="color:var(--text-primary)">${l.utm_source || "Direto"}</span> / ${l.utm_campaign || "-"}
                    </div>
                </div>
            </div>

            <div class="drawer-section">
                <div class="drawer-section-title"><i data-lucide="brain-circuit" style="width:16px"></i> Inteligência</div>
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">Score Interno</div>
                        <div class="info-value score">${score}</div>
                    </div>
                    ${l.serasa_score ? `
                    <div class="info-card">
                        <div class="info-label">Serasa Score</div>
                        <div class="info-value serasa">${l.serasa_score}</div>
                    </div>` : ''}
                    ${l.abandoned_step ? `
                    <div class="info-card" style="grid-column: span 2">
                        <div class="info-label">Abandono</div>
                        <div class="info-value" style="color:var(--error)">Etapa ${l.abandoned_step}</div>
                    </div>` : ''}
                </div>
            </div>

            <div class="drawer-section">
                <div class="drawer-section-title"><i data-lucide="list-checks" style="width:16px"></i> Respostas</div>
                ${responses.map(r => `
                    <div class="response-item">
                        <div class="response-label">${r.form_fields ? r.form_fields.label : "Campo"}</div>
                        <div class="response-val">${r.response_value}</div>
                    </div>
                `).join("")}
                ${!responses.length ? '<div class="text-muted" style="font-size:.85rem">Nenhuma resposta.</div>' : ''}
            </div>

            <div class="drawer-section">
                <div class="drawer-section-title"><i data-lucide="history" style="width:16px"></i> Timeline</div>
                <div class="timeline">
                    ${timeline.map(t => {
                        const date = new Date(t.created_at).toLocaleString("pt-BR", { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                        let icon = "activity";
                        let color = "var(--text-muted)";

                        if(t.event_type === 'lead_started') { icon = "play"; color = "var(--accent)"; }
                        if(t.event_type === 'form_submit') { icon = "check-circle-2"; color = "var(--success)"; }
                        if(t.event_type === 'status_change') { icon = "refresh-ccw"; color = "#F59E0B"; }

                        return `
                        <div class="timeline-item">
                            <div class="timeline-dot" style="border-color:${color}"></div>
                            <div class="timeline-date">${date}</div>
                            <div class="timeline-content">
                                <div style="font-weight:600;display:flex;align-items:center;gap:6px">
                                    <i data-lucide="${icon}" style="width:14px;color:${color}"></i>
                                    ${t.event_type}
                                </div>
                                ${t.metadata ? `<div class="timeline-meta"><pre style="margin:0;white-space:pre-wrap;font-family:inherit">${JSON.stringify(t.metadata, null, 2).replace(/[{}"],?/g, '')}</pre></div>` : ''}
                            </div>
                        </div>`;
                    }).join("")}
                    ${!timeline.length ? '<div class="text-muted" style="font-size:.85rem">Nenhum evento.</div>' : ''}
                </div>
            </div>
        `;

        container.innerHTML = html;
        lucide.createIcons();
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
