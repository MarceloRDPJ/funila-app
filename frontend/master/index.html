<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — Master</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../admin/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>MASTER</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="index.html" class="active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Clientes
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <h1 class="page-title">Gestão de Clientes</h1>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ Novo Cliente</button>
    </div>

    <div class="page-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Plano</th>
                        <th>Status</th>
                        <th>Criado em</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="clients-body"></tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <span class="modal-title">Novo Cliente</span>
            <button class="modal-close" onclick="closeModal()">&#x2715;</button>
        </div>
        <form id="client-form" class="modal-form" onsubmit="createClient(event)">
            <div class="form-group">
                <label>Nome da empresa / corretor</label>
                <input type="text" id="c-name" required placeholder="Ex: João Corretor">
            </div>
            <div class="form-group">
                <label>E-mail (login)</label>
                <input type="email" id="c-email" required placeholder="cliente@email.com">
            </div>
            <div class="form-group">
                <label>Senha provisória</label>
                <input type="text" id="c-password" required minlength="8" placeholder="Mínimo 8 caracteres">
            </div>
            <div class="form-group">
                <label>WhatsApp <span style="color:var(--text-muted);font-weight:400">(opcional — usado na mensagem do lead)</span></label>
                <input type="text" id="c-whatsapp" placeholder="(62) 99999-9999">
            </div>
            <div class="form-group">
                <label>Plano</label>
                <select id="c-plan">
                    <option value="solo">Solo — R$ 147/mês</option>
                    <option value="pro">Pro — R$ 247/mês</option>
                    <option value="agency">Agency — R$ 497/mês</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="create-btn">Criar cliente</button>
            </div>
        </form>
    </div>
</div>

<script src="../admin/js/auth.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const session = await Auth.checkAuth();
        if (!session) return;

        // Verifica se é master
        const res = await fetch(`${Auth.API_URL}/auth/me`, {
            headers: { "Authorization": `Bearer ${session.access_token}` }
        });
        if (!res.ok) { window.location.href = "../admin/dashboard.html"; return; }
        const profile = await res.json();
        if (profile.role !== "master") { window.location.href = "../admin/dashboard.html"; return; }

        loadClients();
    });

    function openModal()  { document.getElementById("modal").classList.add("open"); }
    function closeModal() { document.getElementById("modal").classList.remove("open"); document.getElementById("client-form").reset(); }

    async function loadClients() {
        const session = await Auth.checkAuth();
        if (!session) return;

        const res = await fetch(`${Auth.API_URL}/admin/master/clients`, {
            headers: { "Authorization": `Bearer ${session.access_token}` }
        });
        const clients = await res.json();
        const tbody = document.getElementById("clients-body");

        if (!clients.length) {
            tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><p>Nenhum cliente cadastrado.</p></div></td></tr>`;
            return;
        }

        const planLabel = { solo: "Solo", pro: "Pro", agency: "Agency" };

        tbody.innerHTML = clients.map(c => {
            const date = new Date(c.created_at).toLocaleDateString("pt-BR");
            return `
                <tr>
                    <td data-label="Cliente">
                        <div style="font-weight:500">${c.name}</div>
                        <div class="text-muted">${c.email}</div>
                    </td>
                    <td data-label="Plano"><span class="status-badge status-warm">${planLabel[c.plan] || c.plan}</span></td>
                    <td data-label="Status">
                        <span class="status-badge ${c.active ? "status-hot" : "status-cold"}">${c.active ? "Ativo" : "Inativo"}</span>
                    </td>
                    <td data-label="Criado em"><span class="text-muted">${date}</span></td>
                    <td data-label="Ações">
                        <button class="btn btn-outline" style="padding:5px 10px;font-size:.8rem"
                            onclick="toggleActive('${c.id}', ${c.active})">
                            ${c.active ? "Desativar" : "Ativar"}
                        </button>
                    </td>
                </tr>`;
        }).join("");
    }

    async function createClient(e) {
        e.preventDefault();
        const session = await Auth.checkAuth();
        if (!session) return;

        const btn = document.getElementById("create-btn");
        btn.disabled = true;
        btn.textContent = "Criando...";

        const payload = {
            name:      document.getElementById("c-name").value,
            email:     document.getElementById("c-email").value,
            password:  document.getElementById("c-password").value,
            whatsapp:  document.getElementById("c-whatsapp").value || null,
            plan:      document.getElementById("c-plan").value
        };

        const res = await fetch(`${Auth.API_URL}/admin/master/clients`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${session.access_token}`, "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        btn.disabled = false;
        btn.textContent = "Criar cliente";

        if (res.ok) {
            closeModal();
            loadClients();
        } else {
            const err = await res.json().catch(() => ({}));
            alert("Erro: " + (err.detail || "Tente novamente."));
        }
    }

    async function toggleActive(id, currentlyActive) {
        const session = await Auth.checkAuth();
        if (!session) return;
        await fetch(`${Auth.API_URL}/admin/master/clients/${id}`, {
            method: "PATCH",
            headers: { "Authorization": `Bearer ${session.access_token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ active: !currentlyActive })
        });
        loadClients();
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
