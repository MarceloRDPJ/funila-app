<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — Links</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Leads
        </a></li>
        <li class="nav-item"><a href="links.html" class="active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg>
            Formulário
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <h1 class="page-title">Links de Campanha</h1>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ Novo Link</button>
    </div>

    <div class="page-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Link de rastreamento</th>
                        <th>Destino</th>
                        <th>UTM Source</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="links-body"></tbody>
            </table>
        </div>
    </div>
</main>

<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <span class="modal-title">Novo Link de Campanha</span>
            <button class="modal-close" onclick="closeModal()">&#x2715;</button>
        </div>
        <form id="link-form" class="modal-form" onsubmit="createLink(event)">
            <div class="form-group">
                <label>Nome da campanha</label>
                <input type="text" id="link-name" required placeholder="Ex: Instagram Setor Oeste">
            </div>
            <div class="form-group">
                <label>URL de destino (Squeeze Page)</label>
                <input type="url" id="link-dest" required placeholder="https://app.funila.com.br/frontend/form/index.html">
            </div>
            <div class="form-group">
                <label>UTM Source <span style="color:var(--text-muted);font-weight:400">(opcional)</span></label>
                <input type="text" id="link-utm" placeholder="instagram, google, facebook...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="create-btn">Criar link</button>
            </div>
        </form>
    </div>
</div>

<script src="js/auth.js"></script>
<script>
    const TRACKER_BASE = "https://funila-app.onrender.com";

    document.addEventListener("DOMContentLoaded", async () => {
        const session = await Auth.checkAuth();
        if (session) loadLinks();
    });

    function openModal()  { document.getElementById("modal").classList.add("open"); }
    function closeModal() { document.getElementById("modal").classList.remove("open"); document.getElementById("link-form").reset(); }

    async function loadLinks() {
        const session = await Auth.checkAuth();
        if (!session) return;

        const res = await fetch(`${Auth.API_URL}/links`, {
            headers: { "Authorization": `Bearer ${session.access_token}` }
        });
        const links = await res.json();

        const tbody = document.getElementById("links-body");
        if (!links.length) {
            tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><p>Nenhum link criado ainda.</p></div></td></tr>`;
            return;
        }

        tbody.innerHTML = links.map(link => {
            const shortUrl = `${TRACKER_BASE}/t/${link.slug}`;
            return `
                <tr>
                    <td data-label="Nome"><span style="font-weight:500">${link.name}</span></td>
                    <td data-label="Link">
                        <span class="font-mono" style="color:var(--accent)">${link.slug}</span>
                    </td>
                    <td data-label="Destino"><span class="text-muted truncate">${link.destination}</span></td>
                    <td data-label="UTM"><span class="text-muted">${link.utm_source || "—"}</span></td>
                    <td data-label="Ações" style="display:flex;gap:6px">
                        <button class="btn btn-outline" style="padding:5px 10px;font-size:.8rem"
                            onclick="copyLink('${shortUrl}', this)">Copiar</button>
                        <button class="btn btn-outline" style="padding:5px 10px;font-size:.8rem;color:var(--error);border-color:rgba(248,113,113,.3)"
                            onclick="deleteLink('${link.id}')">Excluir</button>
                    </td>
                </tr>`;
        }).join("");
    }

    async function createLink(e) {
        e.preventDefault();
        const session = await Auth.checkAuth();
        if (!session) return;

        const btn = document.getElementById("create-btn");
        btn.disabled = true;
        btn.textContent = "Criando...";

        const payload = {
            name:        document.getElementById("link-name").value,
            destination: document.getElementById("link-dest").value,
            utm_source:  document.getElementById("link-utm").value || null
        };

        const res = await fetch(`${Auth.API_URL}/links`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${session.access_token}`, "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        btn.disabled = false;
        btn.textContent = "Criar link";

        if (res.ok) {
            closeModal();
            loadLinks();
        } else {
            const err = await res.json().catch(() => ({}));
            alert(err.detail || "Erro ao criar link.");
        }
    }

    async function deleteLink(id) {
        if (!confirm("Excluir este link? Cliques existentes serão mantidos.")) return;
        const session = await Auth.checkAuth();
        if (!session) return;
        await fetch(`${Auth.API_URL}/links/${id}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${session.access_token}` }
        });
        loadLinks();
    }

    function copyLink(url, btn) {
        navigator.clipboard.writeText(url).then(() => {
            const original = btn.textContent;
            btn.textContent = "Copiado!";
            setTimeout(() => { btn.textContent = original; }, 1500);
        });
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
