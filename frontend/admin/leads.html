<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — CRM de Leads</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CRM Specific Styles */
        .crm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .lead-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        .lead-card:hover {
            border-color: var(--border-strong);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .lead-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .lead-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lead-score-badge {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.85rem;
        }

        .lead-body {
            margin-bottom: 20px;
        }
        .lead-status-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-pill.abandoned { background: rgba(248, 113, 113, 0.1); color: var(--error); border: 1px solid rgba(248, 113, 113, 0.2); }
        .status-pill.completed { background: rgba(34, 197, 94, 0.1); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.2); }

        .step-indicator {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .lead-actions {
            display: grid;
            grid-template-columns: 1fr 40px;
            gap: 10px;
        }

        .btn-whatsapp-crm {
            background: #25D366;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            transition: var(--transition);
        }
        .btn-whatsapp-crm:hover { background: #1DA851; transform: translateY(-1px); }

        .btn-icon {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-strong);
            color: var(--text-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-icon:hover { color: var(--text-primary); border-color: var(--text-primary); }

        @media (max-width: 768px) {
            .page-header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .filter-bar { padding: 16px; flex-direction: column; align-items: stretch; }
            .filter-bar input { width: 100%; }
        }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <i data-lucide="layout-dashboard" class="nav-icon"></i>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html" class="active">
            <i data-lucide="users" class="nav-icon"></i>
            Leads CRM
        </a></li>
        <li class="nav-item"><a href="links.html">
            <i data-lucide="link" class="nav-icon"></i>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <i data-lucide="clipboard-list" class="nav-icon"></i>
            Formulário
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <i data-lucide="log-out" class="nav-icon" style="width:16px;height:16px"></i>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <i data-lucide="menu"></i>
            </button>
            <h1 class="page-title">Gestão de Leads</h1>
        </div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-outline" onclick="exportLeads()">
                <i data-lucide="download" style="width:16px"></i>
                CSV
            </button>
            <button class="btn btn-outline" onclick="loadLeads()">
                <i data-lucide="refresh-cw" style="width:16px"></i>
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <select id="filter-status" onchange="loadLeads(1)">
            <option value="">Todos os status</option>
            <option value="hot">Quente</option>
            <option value="warm">Morno</option>
            <option value="cold">Frio / Incompleto</option>
            <option value="converted">Convertido</option>
        </select>
        <div style="position:relative;flex:1">
            <i data-lucide="search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;color:var(--text-muted)"></i>
            <input type="search" id="filter-search" placeholder="Buscar nome, telefone..."
                oninput="debounceSearch()" style="padding-left:32px;width:100%">
        </div>
    </div>

    <div class="page-body" style="padding-top:0">
        <div id="leads-container" class="crm-grid">
            <!-- Leads will be injected here -->
            <div class="empty-state" style="grid-column:1/-1">
                <div class="spinner"></div>
            </div>
        </div>

        <div class="pagination" id="pagination-controls" style="display:flex;justify-content:center;align-items:center;gap:16px;margin-top:32px;margin-bottom:40px">
            <!-- Pagination injected by JS -->
        </div>
    </div>
</main>

<!-- Modal Detalhes -->
<div class="modal-overlay" id="lead-modal">
    <div class="modal-box" style="max-width:600px">
        <div class="modal-header">
            <h3 class="modal-title">Detalhes do Lead</h3>
            <button class="modal-close" onclick="closeModal()">✕</button>
        </div>
        <div id="lead-modal-content">
            <div style="text-align:center;padding:20px"><div class="spinner"></div></div>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script src="js/auth.js"></script>
<script>
    let currentPage = 1;
    let limit = 12; // Card layout fits better with 3 or 4 cols
    let searchTimer = null;

    document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const session = await Auth.checkAuth();
        if (session) loadLeads();
    });

    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => loadLeads(1), 500);
    }

    async function loadLeads(page = 1) {
        currentPage = page;
        const session = await Auth.checkAuth();
        if (!session) return;

        const statusFilter = document.getElementById("filter-status").value;
        const searchFilter = document.getElementById("filter-search").value;

        let url = `${Auth.API_URL}/leads?page=${page}&limit=${limit}`;
        if (statusFilter) url += `&status=${statusFilter}`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro ao buscar leads");
            const json = await res.json();
            renderLeadsCRM(json.data);
            renderPagination(json.total, json.page, json.limit);
        } catch (err) {
            console.error(err);
            document.getElementById("leads-container").innerHTML =
                `<div class="empty-state" style="grid-column:1/-1"><p style="color:var(--error)">Erro ao carregar leads.</p></div>`;
        }
    }

    function renderLeadsCRM(leads) {
        const container = document.getElementById("leads-container");

        if (!leads || !leads.length) {
            container.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><p>Nenhum lead encontrado.</p></div>`;
            return;
        }

        container.innerHTML = leads.map(lead => {
            const score = (lead.internal_score || 0) + (lead.external_score || 0);
            const date  = new Date(lead.created_at).toLocaleDateString("pt-BR", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
            const isIncomplete = lead.status === 'started' || lead.status === 'cold' && !lead.consent_given;
            // Better logic: if score is 0 and status cold, likely incomplete if logic hasn't run.
            // But 'cold' is used for low score too.
            // Let's use metadata or check if 'consent_given' is true.
            // In backend partial save, consent_given is false.

            const abandoned = lead.consent_given === false;

            let statusBadge = `<span class="status-pill completed"><i data-lucide="check-circle" style="width:12px"></i> Novo Lead</span>`;
            if (abandoned) {
                statusBadge = `<span class="status-pill abandoned"><i data-lucide="alert-circle" style="width:12px"></i> Incompleto</span>`;
            } else if (lead.status === 'hot') {
                statusBadge = `<span class="status-pill" style="background:rgba(239,68,68,0.1);color:#EF4444;border-color:rgba(239,68,68,0.2)"><i data-lucide="flame" style="width:12px"></i> Quente</span>`;
            }

            // WhatsApp Message Logic
            const firstName = lead.name ? lead.name.split(" ")[0] : "visitante";
            const msg = abandoned
                ? `Olá ${firstName}, vi que você começou a preencher nosso formulário mas não finalizou. Ficou com alguma dúvida?`
                : `Olá ${firstName}, vi seu perfil e tenho uma oportunidade perfeita para você. Podemos conversar?`;

            const phoneClean = lead.phone ? lead.phone.replace(/\D/g, "") : "";
            const waLink = phoneClean ? `https://wa.me/55${phoneClean}?text=${encodeURIComponent(msg)}` : "#";

            const safeName = lead.name ? lead.name.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "Sem nome";

            return `
            <div class="lead-card">
                <div class="lead-header">
                    <div>
                        <div class="lead-name">${safeName}</div>
                        <div class="lead-meta">
                            <i data-lucide="calendar" style="width:12px"></i> ${date}
                        </div>
                    </div>
                    <div class="lead-score-badge">${score} pts</div>
                </div>

                <div class="lead-body">
                    <div class="lead-status-row">
                        ${statusBadge}
                    </div>
                    ${abandoned ? `<div class="step-indicator">Parou no formulário</div>` : `<div class="step-indicator">Formulário completo</div>`}
                </div>

                <div class="lead-actions">
                    <a href="${waLink}" target="_blank" class="btn-whatsapp-crm" ${!phoneClean ? "disabled style='opacity:0.5;pointer-events:none'" : ""}>
                        <i data-lucide="message-circle" style="width:16px"></i> Atender
                    </a>
                    <button class="btn-icon" onclick="openLeadDetails('${lead.id}')" title="Ver Detalhes">
                        <i data-lucide="eye" style="width:16px"></i>
                    </button>
                </div>
            </div>`;
        }).join("");
        lucide.createIcons();
    }

    function renderPagination(total, page, limit) {
        const totalPages = Math.ceil(total / limit);
        const container = document.getElementById("pagination-controls");

        if (totalPages <= 1) {
            container.innerHTML = "";
            return;
        }

        container.innerHTML = `
            <button class="btn btn-outline" ${page <= 1 ? "disabled" : ""} onclick="loadLeads(${page - 1})">Anterior</button>
            <span class="text-muted" style="font-size:.85rem">Página ${page} de ${totalPages}</span>
            <button class="btn btn-outline" ${page >= totalPages ? "disabled" : ""} onclick="loadLeads(${page + 1})">Próxima</button>
        `;
    }

    async function exportLeads() {
        const session = await Auth.checkAuth();
        if (!session) return;
        const statusFilter = document.getElementById("filter-status").value;
        const searchFilter = document.getElementById("filter-search").value;
        let url = `${Auth.API_URL}/leads/export?`;
        if (statusFilter) url += `&status=${statusFilter}`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, { headers: { "Authorization": `Bearer ${session.access_token}` } });
            if (!res.ok) throw new Error("Erro");
            const blob = await res.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "leads.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch(e) {
            alert("Erro ao exportar");
        }
    }

    async function openLeadDetails(leadId) {
        const modal = document.getElementById("lead-modal");
        const content = document.getElementById("lead-modal-content");
        modal.classList.add("open");
        content.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div></div>';

        const session = await Auth.checkAuth();
        if (!session) return;

        try {
            const res = await fetch(`${Auth.API_URL}/leads/${leadId}`, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro");
            const data = await res.json();
            renderLeadDetails(data, content);
        } catch (e) {
            content.innerHTML = '<div style="color:var(--error);text-align:center">Erro ao carregar.</div>';
        }
    }

    function renderLeadDetails(data, container) {
        const l = data.lead;
        const responses = data.responses || [];
        const events = data.timeline || [];
        const score = (l.internal_score || 0) + (l.external_score || 0);

        let html = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;border-bottom:1px solid var(--border);padding-bottom:24px">
                <div>
                    <div style="font-size:1.4rem;font-weight:600;margin-bottom:4px">${l.name}</div>
                    <div class="text-muted" style="display:flex;gap:12px;align-items:center">
                        <span style="display:flex;gap:4px;align-items:center"><i data-lucide="phone" style="width:14px"></i> ${l.phone}</span>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:2rem;font-weight:700;color:var(--accent);line-height:1">${score}</div>
                    <div class="text-muted" style="font-size:.7rem;font-weight:600;letter-spacing:0.05em">SCORE</div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr;gap:24px;margin-bottom:24px">
                <div>
                    <h4 style="font-size:.85rem;margin-bottom:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;font-weight:600">Dados do Formulário</h4>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        ${responses.map(r => `
                            <div style="font-size:.9rem;background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px;display:flex;justify-content:space-between">
                                <span class="text-muted" style="font-size:.8rem">${r.form_fields ? r.form_fields.label : "Campo"}</span>
                                <span style="font-weight:500;color:var(--text-primary)">${r.response_value}</span>
                            </div>
                        `).join("")}
                        ${!responses.length ? '<div class="text-muted" style="font-size:.85rem">Nenhuma resposta registrada.</div>' : ''}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fechar</button>
            </div>
        `;
        container.innerHTML = html;
        lucide.createIcons();
    }

    function closeModal() {
        document.getElementById("lead-modal").classList.remove("open");
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
