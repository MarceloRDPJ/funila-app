<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funila — CRM de Leads</title>
    <link rel="icon" href="/frontend/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="kanban.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
    <div class="brand">FUNILA <span>PRO</span></div>
    <ul class="nav-links">
        <li class="nav-item"><a href="dashboard.html">
            <i data-lucide="layout-dashboard" class="nav-icon"></i>
            Dashboard
        </a></li>
        <li class="nav-item"><a href="leads.html" class="active">
            <i data-lucide="users" class="nav-icon"></i>
            Leads CRM
        </a></li>
        <li class="nav-item"><a href="links.html">
            <i data-lucide="link" class="nav-icon"></i>
            Links
        </a></li>
        <li class="nav-item"><a href="forms.html">
            <i data-lucide="clipboard-list" class="nav-icon"></i>
            Formulário
        </a></li>
    </ul>
    <div class="user-info">
        <button class="logout-btn" onclick="Auth.logout()">
            <i data-lucide="log-out" class="nav-icon" style="width:16px;height:16px"></i>
            Sair
        </button>
    </div>
</aside>

<main class="main-content">
    <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
            <button class="mobile-menu-btn" onclick="openSidebar()">
                <i data-lucide="menu"></i>
            </button>
            <h1 class="page-title">Gestão de Leads</h1>
        </div>
        <div style="display:flex;gap:10px">
            <button class="btn btn-outline" onclick="exportLeads()">
                <i data-lucide="download" style="width:16px"></i>
                CSV
            </button>
            <button class="btn btn-outline" onclick="loadLeads()">
                <i data-lucide="refresh-cw" style="width:16px"></i>
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <!-- Kanban doesn't filter status usually, but we keep search -->
        <div style="position:relative;flex:1">
            <i data-lucide="search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;color:var(--text-muted)"></i>
            <input type="search" id="filter-search" placeholder="Buscar nome, telefone..."
                oninput="debounceSearch()" style="padding-left:32px;width:100%">
        </div>
    </div>

    <div class="page-body" style="padding-top:0">
        <!-- Kanban Board Container -->
        <div id="kanban-board" class="kanban-board">
            <div class="empty-state" style="width:100%">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Pagination (Hidden for infinite scroll or if unused, but we keep for safety if limit reached) -->
        <div class="pagination" id="pagination-controls" style="display:flex;justify-content:center;align-items:center;gap:16px;margin-top:10px;margin-bottom:20px">
        </div>
    </div>
</main>

<!-- Modal Detalhes -->
<div class="modal-overlay" id="lead-modal">
    <div class="modal-box" style="max-width:600px">
        <div class="modal-header">
            <h3 class="modal-title">Detalhes do Lead</h3>
            <button class="modal-close" onclick="closeModal()">✕</button>
        </div>
        <div id="lead-modal-content">
            <div style="text-align:center;padding:20px"><div class="spinner"></div></div>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script src="js/auth.js"></script>
<script src="kanban.js"></script>
<script>
    let currentPage = 1;
    let limit = 100; // Increase limit for Kanban to show more leads
    let searchTimer = null;

    document.addEventListener("DOMContentLoaded", async () => {
        lucide.createIcons();
        const session = await Auth.checkAuth();
        if (session) loadLeads();
    });

    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => loadLeads(1), 500);
    }

    async function loadLeads(page = 1) {
        currentPage = page;
        const session = await Auth.checkAuth();
        if (!session) return;

        const searchFilter = document.getElementById("filter-search").value;

        // Note: We removed status filter because Kanban shows all columns
        let url = `${Auth.API_URL}/leads?page=${page}&limit=${limit}`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro ao buscar leads");
            const json = await res.json();

            // Use Kanban renderer from kanban.js
            if (typeof renderKanbanBoard === 'function') {
                renderKanbanBoard(json.data);
            } else {
                console.error("renderKanbanBoard not found");
            }

            renderPagination(json.total, json.page, json.limit);
        } catch (err) {
            console.error(err);
            document.getElementById("kanban-board").innerHTML =
                `<div class="empty-state" style="width:100%"><p style="color:var(--error)">Erro ao carregar leads.</p></div>`;
        }
    }

    function renderPagination(total, page, limit) {
        const totalPages = Math.ceil(total / limit);
        const container = document.getElementById("pagination-controls");

        if (totalPages <= 1) {
            container.innerHTML = "";
            return;
        }

        container.innerHTML = `
            <button class="btn btn-outline" ${page <= 1 ? "disabled" : ""} onclick="loadLeads(${page - 1})">Anterior</button>
            <span class="text-muted" style="font-size:.85rem">Página ${page} de ${totalPages}</span>
            <button class="btn btn-outline" ${page >= totalPages ? "disabled" : ""} onclick="loadLeads(${page + 1})">Próxima</button>
        `;
    }

    async function exportLeads() {
        const session = await Auth.checkAuth();
        if (!session) return;
        const searchFilter = document.getElementById("filter-search").value;
        let url = `${Auth.API_URL}/leads/export?`;
        if (searchFilter) url += `&search=${searchFilter}`;

        try {
            const res = await fetch(url, { headers: { "Authorization": `Bearer ${session.access_token}` } });
            if (!res.ok) throw new Error("Erro");
            const blob = await res.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = downloadUrl;
            a.download = "leads.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch(e) {
            alert("Erro ao exportar");
        }
    }

    async function openLeadDetails(leadId) {
        const modal = document.getElementById("lead-modal");
        const content = document.getElementById("lead-modal-content");
        modal.classList.add("open");
        content.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner"></div></div>';

        const session = await Auth.checkAuth();
        if (!session) return;

        try {
            const res = await fetch(`${Auth.API_URL}/leads/${leadId}`, {
                headers: { "Authorization": `Bearer ${session.access_token}` }
            });
            if (!res.ok) throw new Error("Erro");
            const data = await res.json();
            renderLeadDetails(data, content);
        } catch (e) {
            content.innerHTML = '<div style="color:var(--error);text-align:center">Erro ao carregar.</div>';
        }
    }

    function renderLeadDetails(data, container) {
        const l = data.lead;
        const responses = data.responses || [];
        const score = (l.internal_score || 0) + (l.external_score || 0);

        // Additional enrichment data display
        let enrichmentHtml = "";
        if (l.public_api_data || l.whatsapp_meta || l.serasa_score) {
            enrichmentHtml = `<div style="margin-top:24px;border-top:1px solid var(--border);padding-top:24px">
                <h4 style="font-size:.85rem;margin-bottom:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;font-weight:600">Enriquecimento de Dados</h4>
                <div style="display:grid;gap:12px">`;

            if (l.serasa_score) {
                enrichmentHtml += `<div class="form-group"><label>Serasa Score</label><div class="card-value" style="font-size:1.2rem">${l.serasa_score}</div></div>`;
            }
            if (l.whatsapp_meta) {
                const wm = l.whatsapp_meta;
                enrichmentHtml += `<div class="form-group"><label>WhatsApp Status</label>
                    <div style="display:flex;align-items:center;gap:8px">
                        ${wm.valid ? '<span class="status-badge status-hot">Válido</span>' : '<span class="status-badge status-error">Inválido</span>'}
                        ${wm.profile_pic ? `<img src="${wm.profile_pic}" style="width:32px;height:32px;border-radius:50%">` : ''}
                    </div>
                </div>`;
            }
            enrichmentHtml += `</div></div>`;
        }

        let html = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;border-bottom:1px solid var(--border);padding-bottom:24px">
                <div>
                    <div style="font-size:1.4rem;font-weight:600;margin-bottom:4px">${l.name}</div>
                    <div class="text-muted" style="display:flex;gap:12px;align-items:center">
                        <span style="display:flex;gap:4px;align-items:center"><i data-lucide="phone" style="width:14px"></i> ${l.phone}</span>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:2rem;font-weight:700;color:var(--accent);line-height:1">${score}</div>
                    <div class="text-muted" style="font-size:.7rem;font-weight:600;letter-spacing:0.05em">SCORE</div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr;gap:24px;margin-bottom:24px">
                <div>
                    <h4 style="font-size:.85rem;margin-bottom:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.05em;font-weight:600">Dados do Formulário</h4>
                    <div style="display:flex;flex-direction:column;gap:10px">
                        ${responses.map(r => `
                            <div style="font-size:.9rem;background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px;display:flex;justify-content:space-between">
                                <span class="text-muted" style="font-size:.8rem">${r.form_fields ? r.form_fields.label : "Campo"}</span>
                                <span style="font-weight:500;color:var(--text-primary)">${r.response_value}</span>
                            </div>
                        `).join("")}
                        ${!responses.length ? '<div class="text-muted" style="font-size:.85rem">Nenhuma resposta registrada.</div>' : ''}
                    </div>
                </div>
            </div>

            ${enrichmentHtml}

            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Fechar</button>
            </div>
        `;
        container.innerHTML = html;
        lucide.createIcons();
    }

    function closeModal() {
        document.getElementById("lead-modal").classList.remove("open");
    }

    function openSidebar() {
        document.getElementById("sidebar").classList.add("open");
        document.getElementById("sidebar-overlay").classList.add("open");
    }
    function closeSidebar() {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar-overlay").classList.remove("open");
    }
</script>
</body>
</html>
